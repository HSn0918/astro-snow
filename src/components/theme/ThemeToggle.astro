<div
  class="theme-toggle text-2xl cursor-pointer transition-transform duration-300 hover:scale-110"
  id="theme-toggle-btn"
  role="button"
  tabindex="0"
  aria-label="toggle theme"
>
  <i class="fa-solid fa-sun text-2xl light-icon transition-all duration-300"></i>
  <i class="fa-solid fa-moon text-2xl dark-icon transition-all duration-300"></i>
</div>

<script>
  import '@fortawesome/fontawesome-free/css/all.min.css';

  function setupThemeToggle() {
    const toggleBtn = document.getElementById('theme-toggle-btn');
    if (!toggleBtn) return;

    // 检查按钮是否已经绑定过事件，防止重复绑定
    if (toggleBtn.dataset.listenerAttached === 'true') return;

    const rootElement = document.documentElement;
    const lightIcon = toggleBtn.querySelector('.light-icon') as HTMLElement;
    const darkIcon = toggleBtn.querySelector('.dark-icon') as HTMLElement;

    if (!lightIcon || !darkIcon) return;

    // 根据当前主题更新图标显示
    function updateIcons() {
      const isDarkMode = rootElement.classList.contains('dark');

      if (isDarkMode) {
        lightIcon.style.opacity = '0';
        lightIcon.style.transform = 'rotate(180deg) scale(0)';
        darkIcon.style.opacity = '1';
        darkIcon.style.transform = 'rotate(0deg) scale(1)';
      } else {
        lightIcon.style.opacity = '1';
        lightIcon.style.transform = 'rotate(0deg) scale(1)';
        darkIcon.style.opacity = '0';
        darkIcon.style.transform = 'rotate(-180deg) scale(0)';
      }
    }

    // 初始化图标状态
    updateIcons();

    // 切换主题的函数
    function toggleTheme() {
      const isDark = !rootElement.classList.contains('dark');

      // 获取切换按钮的位置作为动画起点
      const toggleElement = document.querySelector('.theme-toggle');
      let x = window.innerWidth / 2;
      let y = window.innerHeight / 2;

      if (toggleElement) {
        const rect = toggleElement.getBoundingClientRect();
        x = rect.left + rect.width / 2;
        y = rect.top + rect.height / 2;
      }

      // 添加特定的主题切换类，用于区分页面切换和主题切换的过渡效果
      rootElement.classList.add('theme-transition');

      // 使用 View Transitions API 创建过渡动画
      if (!document.startViewTransition) {
        // 浏览器不支持 View Transitions API 时降级处理
        applyTheme(isDark);
        updateIcons();
        // 移除主题过渡类
        setTimeout(() => {
          rootElement.classList.remove('theme-transition');
        }, 100);
        return;
      }

      const transition = document.startViewTransition(() => {
        applyTheme(isDark);
        updateIcons();
      });

      transition.ready
        .then(() => {
          rootElement.style.setProperty('--x', `${x}px`);
          rootElement.style.setProperty('--y', `${y}px`);
        })
        .catch((error) => {
          console.error('过渡动画设置错误:', error);
        });

      // 过渡完成后移除主题过渡类
      transition.finished
        .then(() => {
          rootElement.classList.remove('theme-transition');
        })
        .catch(() => {
          rootElement.classList.remove('theme-transition');
        });
    }

    // 应用主题
    function applyTheme(isDark: boolean): void {
      if (isDark) {
        rootElement.classList.add('dark');
        rootElement.classList.remove('light');
        rootElement.dataset.theme = 'dark'; // For astro-mermaid autoTheme
        localStorage.setItem('theme', 'dark');
      } else {
        rootElement.classList.remove('dark');
        rootElement.classList.add('light');
        rootElement.dataset.theme = 'light'; // For astro-mermaid autoTheme
        localStorage.setItem('theme', 'light');
      }
    }

    // 监听点击事件
    toggleBtn.addEventListener('click', toggleTheme);
    toggleBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleTheme();
      }
    });

    // 标记按钮已绑定事件
    toggleBtn.dataset.listenerAttached = 'true';
  }

  // 首次加载时立即初始化（处理 script 加载晚于 DOM ready 的情况）
  if (document.readyState !== 'loading') {
    setupThemeToggle();
  }

  // 在每次Astro页面加载后运行 (处理客户端路由)
  document.addEventListener('astro:page-load', setupThemeToggle);
</script>

<style>
  .theme-toggle {
    position: relative;
    z-index: 10;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle i {
    position: absolute;
    text-shadow: none;
    filter: none;
  }
</style>
